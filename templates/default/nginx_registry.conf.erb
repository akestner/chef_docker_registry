upstream <%= @name %> {
    <% unless @bind_socket.nil? -%>
    server unix:<%= @bind_socket %>;
    <% end -%>
    server <%= @upstream_host %>:<%= @upstream_port %>;
}

server {
    listen <%= @server_port %>;
    server <%= @server_url %>;

    <% if @ssl %>
    ssl on;
    ssl_certificate <%= @ssl_certificate %>;
    ssl_certificate_key <%= @ssl_certificate_key %>;
    <% end %>

    # disable any limits to avoid HTTP 413 for large image uploads
    client_max_body_size 0;

    <% if @set_host_header %>
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    <% end %>

    proxy_set_header Authorization  "";

    location / {
        auth_basic <%= @auth_greeting %>;
        auth_basic_user_file <%= @auth_users_file %>;

        proxy_pass  http://<%= @server_url %>;
    }

    location /v1/_ping {
        proxy_pass  http://<%= @server_url %>;
    }

    location /v1/users {
        proxy_pass  http://<%= @server_url %>;
    }
}
